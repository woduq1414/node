<html>
  <head>
    <title>즐거운 채팅방</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='/socket.io/socket.io.js'></script>
    <script
    src="https://code.jquery.com/jquery-3.4.1.js"
    integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://kit.fontawesome.com/43798b0c81.js" crossorigin="anonymous"></script>

  </head>
  <body style="overflow-y:hidden">
    <div class="container" >
        <div style="height:99%">
          <div style="overflow-y:auto;width:25%;height:100%;float: left;">
                <div>
                  name:
                  <h3 id="currentName"><%= name %> </h3>
                  <div class="input-group mb-3">
                      <input id="inputName" type="text" class="form-control" placeholder="Name" aria-label="Name" aria-describedby="setName">
                      <div class="input-group-append">
                        <button class="btn btn-outline-primary" type="button" id="setName">Set</button>
                      </div>
                  </div>
                  <hr>
                  <button class="btn btn-primary" id="makeRoom" style="width:100%">Room +</button>

                  <div id="roomContainer">
      
                  </div>

                  지금까지 한거 : 방 만들기, 닉네임 만들기, 방 이름/비번 바꾸기, 방장 위임하기, 강퇴하기
                  <br>
                  할 거 : 

                </div>
          </div>
          <div id="chatContainer" style="width:75%;height:100%;float: left;">
            <div style="height:0px" id="chatRoomManage">
            </div>
            <div>
              <div style="overflow-y:auto;" id="chatting" readonly=''>

              </div>
              <div style="height : 40px" id="chatSendArea">
              <input type="text" id="chatArea" style="width:80%;height:100%;float:left;" ></input>
              <button  class="btn btn-primary" id="chatSend" style="width:20%;height:100%;float:left;">Send</button>
              </div>
            </div>
            
          </div>
        </div>
       
    </div>
    <div id="popup-content" class="hide" style="display:none">
        <button class='btn btn-primary OK'>OK</button>  
        <h1>Simple popover with a close button.</h1>
        
    </div>
  </body>
  <script>
  
    

    function getColor(text){
      var hash = 0, len = text.length;
      if (text.length === 0) {
          return hash;
      }
      for (i = 0; i < len; i++) {
          charC = text.charCodeAt(i);
          hash = ((hash<<5)-hash)+charC;
          hash = hash & hash; 
      }
      
      hash = hash * hash
      hash = hash % 16777216
      hash = hash.toString(16)
      return hash;
    }

    function chatAppend(type, text){
      if(type == "noticePrimary"){
        $('#chatting').append("<div class='alert alert-primary' style='text-align:center'>" + text + "</div>");
      }else if(type == "chat"){
        $('#chatting').append("<div class='alert alert-light' style='text-align:left'>" + text + "</div>");
      }else if(type == "noticeDanger"){
        $('#chatting').append("<div class='alert alert-danger' style='text-align:center'>" + text + "</div>");
      }
      $("#chatting").scrollTop($("#chatting")[0].scrollHeight);
    }



    //var socket = io(); 
    
    var socket = io({transports: ['websocket'], upgrade: false});
    
    var currentRoom;
    var info;
    var users;
    var currentName = $('#currentName').text().trim();
    //socket.emit('initName', currentName);


    // function bar(data, timeout = 10000) {
    // return new Promise((resolve, reject) => {
    //     let timer;

    //     socket.emit('requestName', socket.id);

    //     function responseHandler(message) {
    //         // resolve promise with the value we got
    //         resolve(message);
    //         clearTimeout(timer);
    //     }

    //     socket.once('getName', responseHandler); 

    //     // set timeout so if a response is not received within a
    //     // reasonable amount of time, the promise will reject
    //     timer = setTimeout(() => {
    //         reject(new Error("timeout waiting for msg"));
    //         socket.removeListener('getName', responseHandler);
    //     }, timeout);

    // });
    // }

    // bar().then(message => {
    //   // you can use message here and only in here
    // });


    function namePopover(roomName){

      if(info[roomName].members[0] == getMyName()){
    
          $('.chatName').each(function(){
            $temp = $(this)
            $(this).popover({
              placement: 'bottom',
              trigger: 'click',
              html: true,
              sanitize: false,
              title: `<span>${$(this).attr("data-sname")}</span>   <a class="close"><i style="font-size:20px" class="fas fa-times"></i></a>`,
              content: 
              `
                    <button data="${$(this).attr("data-sid")}" class="btn btn-primary mandate" type="button" data-toggle="popover" data-placement="bottom" data-html="true" >방장 위임</button>
                    <button data="${$(this).attr("data-sid")}" class="btn btn-danger kick" type="button" data-toggle="popover" data-placement="bottom" data-html="true" >나가 ㅋ</button>
              `
              
            }).on('shown.bs.popover', function(e) {
            
              var current_popover = '#' + $(e.target).attr('aria-describedby');
              console.log(current_popover)
              var $cur_pop = $(current_popover);
            
              $cur_pop.find('.close').click(function(){
                  //console.log('close triggered');
                  $('.chatName').popover('hide');
              });
              $cur_pop.find('.mandate').click(function(){
                  //console.log('close triggered');
                  $('.chatName').popover('hide');
              });
              $cur_pop.find('.kick').click(function(){
                  //console.log('close triggered');
                  $('.chatName').popover('hide');
              });
              
            });
          });
         
      }else{
        $('.chatName').popover('dispose')
      }
    };

      

    function getMyName(){


      // $.ajax({
      //     type: "POST",
      //     url: "/getName",
      //     data: {'id' : users[socket.id]},
      //     async: false,
      //     success:function(data){
      //         //console.log(data)
      //         currentName = data.name.trim();
      //     }
      // });
      // console.count("getMyName")


      return currentName;

    }
  
    function chatSend(){
      var name = $('#currentName').text().trim();
      var text = $('#chatArea').val();
      socket.emit('sendChat', currentRoom, name, text);
      $('#chatArea').val('');
    }

    if(!currentRoom){
      $('#chatContainer').css('visibility', 'hidden');
    }else{
      $('#chatContainer').css('visibility', 'visible');
    }

    //$("#changeRoomNameArea").keyup(function(e){if(e.keyCode == 13)  $(this).parents('swal2-content').next().find('button').trigger("click") });
    $(document).on("click", "#chatRoomManage", function(){
      Swal.fire({
        title: 'Room Manage',
        html: `<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon1">방 이름</span>
  </div>
  <input type="text" id="changeRoomNameArea" class="form-control" placeholder="방 이름" aria-label="방 이름" aria-describedby="basic-addon1" value="${currentRoom}">
</div>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <div class="input-group-text">
      비밀번호
    </div>
    <div class="input-group-text">
      <input id="changePasswordCheck" type="checkbox" aria-label="Checkbox for following text input" ${info[currentRoom].password ? "checked" : ""}>
    </div>
  </div>
  <input id="changePasswordArea" type="password" class="form-control" aria-label="Text input with checkbox" ${info[currentRoom].password ? "" : "disabled"}>
</div>
`,
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Apply',
        inputAttributes: {
          autocapitalize: 'off'
        },
        preConfirm : () => {
          let before = currentRoom
          let after = $('#changeRoomNameArea').val()
          if (before != after){
            socket.emit('changeRoomName', before, after)
            currentRoom = after;
          }

          let passwordCheck = $('#changePasswordCheck').is(":checked")
          if (passwordCheck){
            password = $('#changePasswordArea').val();
            socket.emit('changePassword', currentRoom, password)
          }else{
            password = "";
            socket.emit('changePassword', currentRoom, password)
          }
        }
       
      })
    })

    socket.on('refreshUser', function(data){
      users = data;
      console.log(users);
    })


    socket.on('changePassword', function(roomName, type){
      if(type == 0){
        chatAppend("noticePrimary", `${roomName}의 비밀번호가 해제됨 ㅋ`);
      }else{
        chatAppend("noticePrimary", `${roomName}의 비밀번호가 변경됨 ㅋ`);
      }
    })




    socket.on('changeRoomName', function(before,after){
      chatAppend("noticePrimary", `방의 이름이 ${before}에서 ${after}로 변경됨 ㅋ`);
    })

    socket.on('a',function(data){
      console.log(data);
    })

    $(document).on("click", "#chatSend", function(){
      chatSend();
    })
    $("#chatArea").keyup(function(e){if(e.keyCode == 13)  chatSend(); });

    $("#chatting").css("height", (parseFloat($("#chatContainer").css("height")) -  parseFloat($("#chatRoomManage").css("height")) -  parseFloat($("#chatSendArea").css("height"))) + "px")
    $(window).resize(function(){
      $("#chatting").css("height", (parseFloat($("#chatContainer").css("height")) -  parseFloat($("#chatRoomManage").css("height")) -  parseFloat($("#chatSendArea").css("height"))) + "px")
    })


    $(document).on("click", "#passwordCheck", function(){
      if($(this).is(":checked")){
        $('#passwordArea').prop("disabled", false)
      }else{
        $('#passwordArea').prop("disabled", true)
      }
    })
    $(document).on("click", "#changePasswordCheck", function(){
      if($(this).is(":checked")){
        $('#changePasswordArea').prop("disabled", false)
      }else{
        $('#changePasswordArea').prop("disabled", true)
      }
    })


    $(document).on("click", "#makeRoom", function(){

      Swal.fire({
        title: 'Room Name',
        html: `<div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon1">방 이름</span>
  </div>
  <input type="text" id="roomNameArea" class="form-control" placeholder="방 이름" aria-label="방 이름" aria-describedby="basic-addon1">
</div>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <div class="input-group-text">
      비밀번호
    </div>
    <div class="input-group-text">
      <input id="passwordCheck" type="checkbox" aria-label="Checkbox for following text input">
    </div>
  </div>
  <input id="passwordArea" type="password" class="form-control" aria-label="Text input with checkbox" disabled>
</div>
`,
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Apply',
        inputAttributes: {
          autocapitalize: 'off'
        },
        showLoaderOnConfirm: true,
        preConfirm : () => {
          let password;
          let roomName = $('#roomNameArea').val()
          let passwordCheck = $('#passwordCheck').is(":checked")
          if (passwordCheck){
            password = $('#passwordArea').val()
          }else{
            password = "";
          }
        
          console.log(roomName, passwordCheck, password);
          if(getMyName()){
              socket.emit('makeRoom', roomName, password);
              socket.emit('joinRoom', roomName, getMyName());
          }
       
        }
      })

    })

    socket.on('newRoomMaster', function(roomName, name, socketID){

      chatAppend("noticePrimary", `<span class='chatName' data-sname='${name}' data-sid='${socketID}' style='font-weight:1000;color:#${getColor(name)}'>${name}</span>님이 ${roomName}의 방장이 됨 ㅋ`)

      if(name === getMyName()){
        $('#chatRoomManage').html(`<div class="alert alert-secondary" style="width:100%;height:40px">방 관리</div>`)
        $('#chatRoomManage').css('height', "40px")
        $("#chatting").css("height", (parseFloat($("#chatContainer").css("height")) -  parseFloat($("#chatRoomManage").css("height")) -  parseFloat($("#chatSendArea").css("height"))) + "px")
      }else{
        $('#chatRoomManage').html(`<div class="alert alert-secondary" style="width:100%;height:0px">방 관리</div>`)
        $('#chatRoomManage').css('height', "0px")
        $("#chatting").css("height", (parseFloat($("#chatContainer").css("height")) -  parseFloat($("#chatRoomManage").css("height")) -  parseFloat($("#chatSendArea").css("height"))) + "px")
     
      }
      namePopover(roomName);
    })


    socket.on('receiveChat', function(socketID, roomName, name, text){
      if(info[roomName].members[0] == name){
        chatAppend("chat", `<span data-toggle="popover" data-placement="bottom"  data-html="true" data-sname='${name}' data-sid='${socketID}'
        class='chatName ${socketID}' style='cursor:pointer;font-weight:1000;color:#${getColor(name)}'><i class='fas fa-crown'></i> ${name}</span> : ${text}`)
        
        
        


      }else{
        chatAppend("chat", `<span data-toggle="popover" data-placement="bottom"  data-html="true" data-sname='${name}' data-sid='${socketID}'
                            class='chatName ${socketID}' style='cursor:pointer;font-weight:1000;color:#${getColor(name)}'>${name}</span> : ${text}`)
        
      
      }
      namePopover(roomName);


    })





    socket.on('noticeChangeName', function(before, after, socketID){
  
      chatAppend("noticePrimary", `<span class="chatName" data-sname='${before}' data-sid='${socketID}' style='font-weight:1000;color:#${getColor(before)}'>${before}</span>님이 <span class="chatName" data-sname='${after}' data-sid='${socketID}' style='font-weight:1000;color:#${getColor(after)}'>${after}</span>로 이름 바꿈 ㅋ`);
      namePopover(currentRoom);
    })


    $(document).on("click", ".room", function(){

      var roomName = $(this).children('.roomName').text();
      if (roomName != currentRoom){
        if(info[roomName].password){
          Swal.fire({
            title: 'Password',
            text: '비번',
            input: 'password',
            inputAttributes: {
              autocapitalize: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Make & Enter',
            showLoaderOnConfirm: true,
            preConfirm: (password) => {
              console.log(roomName, password)
              socket.emit('checkPassword', roomName, password);
              
              
              
            },
            allowOutsideClick: () => !Swal.isLoading()
          })
        }else{
          socket.emit('joinRoom', roomName, getMyName());
        }
      }
      


      

    })


    socket.on('checkPassword', function(roomName, isCorrect){
      console.log(isCorrect);
      if (isCorrect){
        
        socket.emit('joinRoom', roomName, getMyName());
        //socket.removeListener('checkPassword');
      }else{
        Swal.fire({
          icon: 'error',
          title: '저런',
          text: '비밀번호 틀렸음 ㅋ'
        })
      }
    })




    $(document).on("click", ".mandate", function(){
      let socketID = $(this).attr('data')
      socket.emit('mandateRoomMaster', currentRoom, socketID )
      
    })
    $(document).on("click", ".kick", function(){
      let socketID = $(this).attr('data')
      socket.emit('kick', currentRoom, socketID )
      
    })


    socket.on('joinRoom', function(roomName, name, socketID, me){
      if (me){
        $('#chatting').html('');
      }
      
      chatAppend("noticePrimary", `<span data-sname='${name}' data-sid='${socketID}' class='chatName ${socketID}' style='font-weight:1000;color:#${getColor(name)}'>${name}</span>님이 ${roomName}에 입장함 ㅋ`)
      currentRoom = roomName;
      
      if(info[roomName].members[0] === getMyName()){
        $('#chatRoomManage').html(`<div class="alert alert-secondary" style="width:100%;height:40px">방 관리</div>`)
        $('#chatRoomManage').css('height', "40px")
        $("#chatting").css("height", (parseFloat($("#chatContainer").css("height")) -  parseFloat($("#chatRoomManage").css("height")) -  parseFloat($("#chatSendArea").css("height"))) + "px")
     
      }else{
        $('#chatRoomManage').html(`<div class="alert alert-secondary" style="width:100%;height:0px">방 관리</div>`)
        $('#chatRoomManage').css('height', "0px")
        $("#chatting").css("height", (parseFloat($("#chatContainer").css("height")) -  parseFloat($("#chatRoomManage").css("height")) -  parseFloat($("#chatSendArea").css("height"))) + "px")
     
      }

      if(!currentRoom){
        $('#chatContainer').css('visibility', 'hidden');
      }else{
        $('#chatContainer').css('visibility', 'visible');
      }
      
      namePopover(roomName);

      
    })
      
    socket.on('leaveRoom', function(roomName, name, socketID, me){
      console.log(roomName, name, me);
      chatAppend("noticeDanger", `<span data-sname='${name}' data-sid='${socketID}' class='chatName ${socketID}' style='font-weight:1000;color:#${getColor(name)}'>${name}</span>님이 ${roomName}을 나감 ㅋ`)
      if(me){
        currentRoom = undefined;
      }
      
      if(!currentRoom){
        $('#chatContainer').css('visibility', 'hidden');
      }else{
        $('#chatContainer').css('visibility', 'visible');
      }

      namePopover(roomName);
    })
      
    socket.on('kickedRoom', function(roomName, name, socketID, me){
      console.log(roomName, name, me);
      chatAppend("noticeDanger", `<span data-sname='${name}' data-sid='${socketID}' class='chatName ${socketID}' style='font-weight:1000;color:#${getColor(name)}'>${name}</span>님이 강퇴당함 ㅋㅋㅋㅋㅋㅋㅋ`)
      if(me){
        currentRoom = undefined;
        Swal.fire({
          icon: 'error',
          title: 'ㅋㅋㅋㅋㅋㅋㅋ',
          text: '강퇴 당함 ㅋ'
        })
      }
      
      if(!currentRoom){
        $('#chatContainer').css('visibility', 'hidden');
      }else{
        $('#chatContainer').css('visibility', 'visible');
      }
      namePopover(roomName);
    })
      



    socket.on('failSetName', function(){
      alert("이미 있는 이름임ㅋ");
    })

    socket.on('successSetName', function(){
      $('#currentName').text($('#inputName').val())
      currentName = $('#inputName').val()
    })

    $(document).on("click", "#setName", function(){

      var a = $('#currentName').text().trim();
      var b = $('#inputName').val()

      socket.emit('changeName', a, b)
      
    })


    socket.on('refreshMain', function(data){
      info = data;
      $('[data-toggle="tooltip"]').tooltip('hide')
      console.log(data);
      var string = "<hr>";
      for (key in data){
        var members = "접속자 : " + data[key]["members"].length + "명";
        for (i in data[key]["members"]){
          if (i == 0){
            members += "<br> <span> <i class='fas fa-crown'></i> " + data[key]["members"][i] + "</span>"
          }else{
            members += "<br> <span>" + data[key]["members"][i] + "</span>"
          }
         
        }

        if(data[key]["members"].includes(getMyName())){
          string += `<div class='room alert alert-warning'
          data-toggle='tooltip' data-placement='bottom' data-html='true' title="${members}"> <h4 class='roomName'>${key}</h4>`
        }else{
          string += `<div class='room alert alert-info'
          data-toggle='tooltip' data-placement='bottom' data-html='true' title="${members}"> <h4 class='roomName'>${key}</h4>`
        }
        

        
        string += "</div>"
        string += "<hr>"
      }
      $('#roomContainer').html(string);

      
      
      $('[data-toggle="tooltip"]').tooltip()
    })

  </script>
</html>